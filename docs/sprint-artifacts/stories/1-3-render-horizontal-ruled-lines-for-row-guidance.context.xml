<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>Render Horizontal Ruled Lines for Row Guidance</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/home/mser/Documents/cla/w/Texo-web-stylus/docs/sprint-artifacts/1-3-render-horizontal-ruled-lines-for-row-guidance.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to see horizontal ruled lines on the canvas</iWant>
    <soThat>I know where to write each line of my mathematical work</soThat>
    <tasks>Task 1: Implement guide line generation utility (AC: #1, #2, #6)
- Subtask 1.1: Create generateGuideLines() function that calculates line positions based on canvas bounds and spacing
- Subtask 1.2: Use existing createGuideLine() infrastructure from Story 1.2
- Subtask 1.3: Generate lines from Y min to Y max of canvas bounds ([-50000, +50000])
- Subtask 1.4: Set default spacing to 384px (matches OCR row height from architecture)
- Subtask 1.5: Calculate number of lines: Math.ceil((yMax - yMin) / spacing)

Task 2: Style guide lines for subtlety and non-interference (AC: #3, #4)
- Subtask 2.1: Set line color to light gray (#d3d3d3 or similar)
- Subtask 2.2: Set line stroke width to 1px
- Subtask 2.3: Set line elements to locked: true (prevents user from selecting/moving)
- Subtask 2.4: Set line elements to non-editable and non-deletable
- Subtask 2.5: Ensure lines render in background layer (z-index or element order)

Task 3: Integrate guide lines into canvas initialization (AC: #1, #5)
- Subtask 3.1: Generate guide lines in useEffect after Excalidraw API is ready
- Subtask 3.2: Add guide lines to initial canvas elements via updateScene()
- Subtask 3.3: Verify lines persist through pan and zoom operations
- Subtask 3.4: Store guide line spacing in component state for future configurability (Story 6.2)
- Subtask 3.5: Test lines remain visible after canvas transformations

Task 4: Optimize rendering performance (AC: #7)
- Subtask 4.1: Implement viewport culling - only render lines visible in current view + buffer
- Subtask 4.2: Debounce line regeneration during rapid zoom changes (100ms)
- Subtask 4.3: Measure frame rate during pan/zoom with guide lines (target: 60fps)
- Subtask 4.4: Profile rendering with 260+ guide lines (for 100,000px canvas)
- Subtask 4.5: Optimize if frame rate drops below target

Task 5: Handle zoom-invariant spacing (AC: #6)
- Subtask 5.1: Subscribe to zoom changes via Excalidraw appState
- Subtask 5.2: Verify line spacing remains constant in canvas coordinates (not screen pixels)
- Subtask 5.3: Test at various zoom levels (50%, 100%, 200%, 400%)
- Subtask 5.4: Ensure lines don't "drift" or misalign during zoom
- Subtask 5.5: Document zoom handling approach for future story reference

Task 6: Integration testing and edge cases
- Subtask 6.1: Test initial render shows all guide lines in viewport
- Subtask 6.2: Test rapid pan/zoom doesn't break line rendering
- Subtask 6.3: Test drawing works normally with lines in background
- Subtask 6.4: Test eraser doesn't delete guide lines (due to locked: true)
- Subtask 6.5: Verify no console warnings or performance degradation</tasks>
  </story>

  <acceptanceCriteria>1. Given I am on the Magic Canvas page When the canvas renders Then I see horizontal ruled lines spaced at regular intervals (default 384px apart)
2. And lines extend across the full width of the visible canvas
3. And lines are subtle (light gray, ~1px stroke)
4. And lines do not interfere with drawing (rendered as background layer)
5. And lines remain visible during pan and zoom operations
6. And spacing adjusts correctly when zoom level changes (maintain constant spacing in canvas coordinates)
7. And lines render performantly (60fps during pan/zoom)</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Magic Canvas Feature Requirements</section>
        <snippet>FR3: Canvas Drawing - Users can draw mathematical equations with stylus input on an infinite vertical canvas. FR4: Row Guidance System - Canvas displays horizontal guide lines to help users organize mathematical work in rows.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Canvas Foundation & Row System</section>
        <snippet>Canvas boundaries: Y [-50000, +50000], Width 2000px. Guide line specification: Default spacing 384px (matches OCR row height), Light gray (#d3d3d3), 1px stroke, Locked elements, Background layer rendering.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Performance Requirements</section>
        <snippet>Canvas rendering must maintain 60fps during pan/zoom operations. Viewport culling required for elements outside visible area. Memory management for large numbers of canvas elements.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Definitions</title>
        <section>Epic 1: Canvas Foundation & Row System</section>
        <snippet>Story 1.3 builds on Story 1.2's Excalidraw integration to implement horizontal guide lines. Uses existing createGuideLine() function. Critical for OCR pipeline alignment in Epic 2.</snippet>
      </doc>
      <doc>
        <path>docs/bmm-architecture.md</path>
        <title>Brownfield Methodology Architecture</title>
        <section>Existing Canvas Infrastructure</section>
        <snippet>Excalidraw integration patterns established in Story 1.2. Component state management via React hooks. updateScene() API for programmatic element manipulation.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Guide Line Implementation</section>
        <snippet>Guide lines must be rendered as background elements with locked: true property. Spacing of 384px aligns with OCR tile boundaries. Performance optimization through viewport culling essential.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/pages/MagicCanvas.jsx</path>
        <kind>component</kind>
        <symbol>createGuideLine</symbol>
        <lines>18-39</lines>
        <reason>Existing function creates guide line elements with proper styling (locked, light gray). Already prepared for Story 1.3 but uses 100px spacing instead of required 384px.</reason>
      </artifact>
      <artifact>
        <path>src/pages/MagicCanvas.jsx</path>
        <kind>component</kind>
        <symbol>generateGuideLines</symbol>
        <lines>42-48</lines>
        <reason>Current implementation generates guide lines with 100px spacing (line 44). CRITICAL: Must change to 384px spacing to match story requirements and OCR alignment.</reason>
      </artifact>
      <artifact>
        <path>src/pages/MagicCanvas.jsx</path>
        <kind>component</kind>
        <symbol>CANVAS_CONFIG</symbol>
        <lines>10-16</lines>
        <reason>Canvas boundaries and configuration constants. Y range [-50000, +50000] and width 2000px used for guide line extent calculation.</reason>
      </artifact>
      <artifact>
        <path>src/pages/MagicCanvas.jsx</path>
        <kind>component</kind>
        <symbol>useEffect</symbol>
        <lines>95-112</lines>
        <reason>Canvas initialization logic where guide lines are added to scene via updateScene(). Integration point for guide line rendering.</reason>
      </artifact>
      <artifact>
        <path>src/pages/MagicCanvas.jsx</path>
        <kind>component</kind>
        <symbol>handleCanvasChange</symbol>
        <lines>114-144</lines>
        <reason>Canvas state tracking including zoom and scroll position needed for viewport culling and zoom-invariant spacing calculations.</reason>
      </artifact>
      <artifact>
        <path>src/contexts/DebugContext.jsx</path>
        <kind>context</kind>
        <symbol>useDebug</symbol>
        <lines>31-37</lines>
        <reason>Debug mode integration for performance monitoring and development visibility during guide line implementation.</reason>
      </artifact>
      <artifact>
        <path>src/pages/SketchPage.jsx</path>
        <kind>component</kind>
        <symbol>createBoundingBox</symbol>
        <lines>49-69</lines>
        <reason>Reference pattern for creating locked Excalidraw elements with specific styling. Similar approach needed for guide lines.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="@excalidraw/excalidraw" version="^0.18.0" usage="Canvas rendering and element manipulation"/>
        <package name="react" version="^18.3.1" usage="Component framework and hooks (useState, useRef, useEffect, useCallback)"/>
        <package name="react-dom" version="^18.3.1" usage="DOM rendering"/>
        <package name="react-helmet-async" version="^2.0.5" usage="Page title management"/>
        <package name="react-router-dom" version="^7.1.1" usage="Navigation and routing"/>
      </ecosystem>
      <ecosystem name="dev">
        <package name="vitest" version="^2.1.8" usage="Testing framework for unit tests"/>
        <package name="tailwindcss" version="^3.4.17" usage="CSS framework for styling"/>
        <package name="vite" version="^6.0.7" usage="Build tool and development server"/>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Performance: Must maintain 60fps during pan/zoom operations with 260+ guide lines visible</constraint>
    <constraint>Memory: Implement viewport culling to avoid rendering off-screen guide lines (buffer zone Â±2000px)</constraint>
    <constraint>Styling: Light gray (#d3d3d3) with 30% opacity, 1px stroke, locked elements, background layer</constraint>
    <constraint>Spacing: Exactly 384px spacing to align with OCR tile boundaries (CRITICAL for Epic 2)</constraint>
    <constraint>Zoom behavior: Maintain constant spacing in canvas coordinates (not screen pixels)</constraint>
    <constraint>Element IDs: Use UUID-based or timestamp-based IDs to prevent collisions with user elements</constraint>
    <constraint>React patterns: Use useCallback for performance-critical functions, proper dependency management</constraint>
    <constraint>Error handling: Graceful degradation if guide line generation fails, fallback to no guide lines</constraint>
    <constraint>Accessibility: WCAG AA contrast ratio compliance (4.5:1 minimum) for visual hierarchy</constraint>
    <constraint>Cleanup: Proper lifecycle management and memory cleanup when component unmounts</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>ExcalidrawAPI.updateScene</name>
      <kind>method</kind>
      <signature>updateScene({ elements: ExcalidrawElement[] })</signature>
      <path>src/pages/MagicCanvas.jsx</path>
    </interface>
    <interface>
      <name>ExcalidrawAPI.getSceneElements</name>
      <kind>method</kind>
      <signature>getSceneElements(): ExcalidrawElement[]</signature>
      <path>src/pages/MagicCanvas.jsx</path>
    </interface>
    <interface>
      <name>ExcalidrawAPI.getAppState</name>
      <kind>method</kind>
      <signature>getAppState(): AppState</signature>
      <path>src/pages/MagicCanvas.jsx</path>
    </interface>
    <interface>
      <name>convertToExcalidrawElements</name>
      <kind>function</kind>
      <signature>convertToExcalidrawElements(elements: RawElement[]): ExcalidrawElement[]</signature>
      <path>src/pages/MagicCanvas.jsx</path>
    </interface>
    <interface>
      <name>useDebug</name>
      <kind>hook</kind>
      <signature>useDebug(): { debugMode: boolean, setDebugMode: Function, toggleDebug: Function }</signature>
      <path>src/contexts/DebugContext.jsx</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Manual testing required for canvas interactions and visual rendering. Performance testing using browser DevTools Performance tab to verify 60fps target. Accessibility testing for WCAG AA contrast compliance. Cross-browser testing (Chrome, Firefox, Safari) for rendering consistency.</standards>
    <locations>Manual testing in browser at MagicCanvas page (/magic-canvas route). Performance monitoring via browser DevTools. Visual regression testing via screenshots. Console monitoring for warnings and errors.</locations>
    <ideas>
      <test idea="AC1: Verify guide lines render on page load with correct 384px spacing">
        <acceptanceCriteria>1</acceptanceCriteria>
        <method>Open Magic Canvas, measure spacing between lines using browser dev tools</method>
      </test>
      <test idea="AC2: Verify lines extend full canvas width (2000px)">
        <acceptanceCriteria>2</acceptanceCriteria>
        <method>Inspect line elements, verify width property equals CANVAS_CONFIG.MAX_WIDTH</method>
      </test>
      <test idea="AC3: Verify visual styling (light gray, 1px stroke)">
        <acceptanceCriteria>3</acceptanceCriteria>
        <method>Check computed styles, verify #d3d3d3 color and 1px stroke width</method>
      </test>
      <test idea="AC4: Verify lines don't interfere with drawing">
        <acceptanceCriteria>4</acceptanceCriteria>
        <method>Draw strokes over guide lines, verify lines remain in background and locked</method>
      </test>
      <test idea="AC5: Verify lines persist during pan/zoom">
        <acceptanceCriteria>5</acceptanceCriteria>
        <method>Pan vertically and zoom in/out, verify lines remain visible and aligned</method>
      </test>
      <test idea="AC6: Verify zoom-invariant spacing">
        <acceptanceCriteria>6</acceptanceCriteria>
        <method>Test at 50%, 100%, 200%, 400% zoom, verify spacing remains constant in canvas coordinates</method>
      </test>
      <test idea="AC7: Verify 60fps performance">
        <acceptanceCriteria>7</acceptanceCriteria>
        <method>Use DevTools Performance tab during rapid pan/zoom, verify frame rate >= 60fps</method>
      </test>
      <test idea="Performance: Viewport culling effectiveness">
        <acceptanceCriteria>7</acceptanceCriteria>
        <method>Monitor memory usage with 260+ lines, verify only visible lines are rendered</method>
      </test>
      <test idea="Edge case: Rapid zoom changes">
        <acceptanceCriteria>6,7</acceptanceCriteria>
        <method>Rapidly zoom from 10% to 1000%, verify no performance degradation or visual artifacts</method>
      </test>
      <test idea="Accessibility: Contrast ratio compliance">
        <acceptanceCriteria>3</acceptanceCriteria>
        <method>Use contrast checker tool, verify ratio meets WCAG AA 4.5:1 minimum</method>
      </test>
      <test idea="Integration: OCR alignment verification">
        <acceptanceCriteria>1,6</acceptanceCriteria>
        <method>Verify 384px spacing aligns with OCR tile boundaries for future Epic 2 integration</method>
      </test>
    </ideas>
  </tests>
</story-context>