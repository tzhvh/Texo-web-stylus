<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>Implement RowManager Class for Row State Tracking</title>
    <status>drafted</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/home/mser/Documents/cla/w/Texo-web-stylus/docs/sprint-artifacts/1-4-implement-rowmanager-class-for-row-state-tracking.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system component</asA>
    <iWant>a RowManager class that tracks rows and their metadata</iWant>
    <soThat>row state can be managed consistently throughout the application</soThat>
    <tasks>- [ ] Task 1: Create RowManager class structure and constructor (AC: #1)
  - [ ] Subtask 1.1: Create `src/utils/rowManager.js` file with class definition
  - [ ] Subtask 1.2: Implement constructor with rowHeight and startY parameters
  - [ ] Subtask 1.3: Initialize Map storage for rows and elementToRow mappings
  - [ ] Subtask 1.4: Set default rowHeight to 384px (matches OCR tile height)
  - [ ] Subtask 1.5: Document class and constructor with JSDoc

- [ ] Task 2: Implement core Row interface and data structure (AC: #8)
  - [ ] Subtask 2.1: Define Row interface with all required properties
  - [ ] Subtask 2.2: Implement row ID generation (deterministic: "row-{index}")
  - [ ] Subtask 2.3: Implement yStart/yEnd calculation based on row index
  - [ ] Subtask 2.4: Initialize default status values (pending, null timestamps)
  - [ ] Subtask 2.5: Add validation for required Row properties

- [ ] Task 3: Implement getRowForY method (AC: #2)
  - [ ] Subtask 3.1: Calculate row index from Y coordinate: `Math.floor((y - startY) / rowHeight)`
  - [ ] Subtask 3.2: Generate row ID: `"row-${rowIndex}"`
  - [ ] Subtask 3.3: Return existing row or create new row if not exists
  - [ ] Subtask 3.4: Handle edge cases (Y below startY, negative coordinates)
  - [ ] Subtask 3.5: Add unit tests for various Y coordinates

- [ ] Task 4: Implement assignElement method (AC: #3, #10)
  - [ ] Subtask 4.1: Extract element center Y coordinate from bounding box
  - [ ] Subtask 4.2: Call getRowForY to determine target row
  - [ ] Subtask 4.3: Remove element from previous row if assigned elsewhere
  - [ ] Subtask 4.4: Add element ID to target row's elementIds Set
  - [ ] Subtask 4.5: Update elementToRow mapping and row's lastModified timestamp

- [ ] Task 5: Implement row retrieval and update methods (AC: #4, #5, #6, #7)
  - [ ] Subtask 5.1: Implement getRow(rowId) to return row from Map
  - [ ] Subtask 5.2: Implement updateRow(rowId, updates) with partial updates
  - [ ] Subtask 5.3: Implement getAllRows() to return Array from Map values
  - [ ] Subtask 5.4: Implement getRowsInViewport(viewport) with bounds checking
  - [ ] Subtask 5.5: Add error handling for invalid row IDs

- [ ] Task 6: Implement row stability and persistence support (AC: #9)
  - [ ] Subtask 6.1: Ensure row IDs are deterministic based on Y position
  - [ ] Subtask 6.2: Implement serialize() method for state persistence
  - [ ] Subtask 6.3: Implement deserialize() method for state restoration
  - [ ] Subtask 6.4: Test row ID consistency across save/load cycles
  - [ ] Subtask 6.5: Validate row assignments survive pan/zoom operations

- [ ] Task 7: Add comprehensive unit tests
  - [ ] Subtask 7.1: Test RowManager instantiation and initialization
  - [ ] Subtask 7.2: Test getRowForY with various Y coordinates
  - [ ] Subtask 7.3: Test assignElement with new and existing elements
  - [ ] Subtask 7.4: Test row updates and retrieval methods
  - [ ] Subtask 7.5: Test edge cases (elements spanning rows, invalid inputs)</tasks>
  </story>

  <acceptanceCriteria>| # | Acceptance Criterion |
|---|---|
| 1 | **Given** Magic Canvas page needs to track rows **When** RowManager is instantiated with configuration (row height, starting Y position) **Then** it provides methods to get row for Y coordinate, assign elements, update rows, and retrieve row data |
| 2 | **And** `getRowForY(y: number): Row` returns row containing given Y coordinate |
| 3 | **And** `assignElement(element: ExcalidrawElement): rowId` assigns element to appropriate row and returns rowId |
| 4 | **And** `getRow(rowId: string): Row` retrieves row metadata by ID |
| 5 | **And** `updateRow(rowId: string, updates: Partial<Row>): void` updates row metadata |
| 6 | **And** `getAllRows(): Row[]` returns all tracked rows |
| 7 | **And** `getRowsInViewport(viewport: Viewport): Row[]` returns visible rows for given viewport |
| 8 | **And** each Row object includes id, yStart, yEnd, elementIds, ocrStatus, validationStatus, transcribedLatex, lastModified, tileHash, errorMessage |
| 9 | **And** row IDs remain stable across pan/zoom/reload operations |
| 10 | **And** RowManager handles edge cases (elements spanning multiple rows â†’ assign to primary row based on center Y) |</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/PRD.md" title="Product Requirements Document" section="Magic Canvas Row System" snippet="The Magic Canvas shall organize mathematical expressions into horizontal rows with automatic element assignment, persistent row state, and visual status indicators for OCR and validation results."/>
      <doc path="docs/architecture.md" title="System Architecture" section="RowManager Class" snippet="RowManager serves as the authoritative source for row state, providing O(1) lookup performance and stable identifiers across pan/zoom operations. Integrates with Excalidraw canvas and IndexedDB persistence."/>
      <doc path="docs/bmm-architecture.md" title="Magic Canvas Technical Architecture" section="Row System Design" snippet="Row height: 384px (configurable, matches OCR tile boundaries). Row ID format: 'row-{index}' deterministic based on Y position. Storage: Map&lt;string, Row&gt; for O(1) lookups."/>
      <doc path="docs/tech-spec-epic-1.md" title="Epic 1 Technical Specification" section="Data Models and Contracts" snippet="Row interface includes id, yStart, yEnd, elementIds, ocrStatus, validationStatus, transcribedLatex, lastModified, tileHash, errorMessage. RowManager API: getRowForY(), assignElement(), getRow(), updateRow(), getAllRows(), getRowsInViewport()."/>
      <doc path="docs/sprint-artifacts/1-3-render-horizontal-ruled-lines-for-row-guidance.md" title="Previous Story Implementation" section="Technical Patterns Established" snippet="Guide line spacing: 384px (aligns with OCR tile boundaries). Performance patterns established for handling large numbers of elements. Component architecture ready for RowManager integration."/>
    </docs>
    <code>
      <codeRef path="src/pages/MagicCanvas.jsx" kind="component" symbol="MagicCanvas" lines="17-22" reason="Canvas configuration constants (MIN_Y, MAX_Y, MAX_WIDTH) needed for RowManager bounds"/>
      <codeRef path="src/pages/MagicCanvas.jsx" kind="function" symbol="generateGuideLines" lines="48-54" reason="384px spacing pattern for OCR tile alignment"/>
      <codeRef path="src/pages/MagicCanvas.jsx" kind="function" symbol="generateViewportGuideLines" lines="59-74" reason="Viewport culling pattern for performance optimization"/>
      <codeRef path="src/pages/MagicCanvas.jsx" kind="function" symbol="debounce" lines="77-87" reason="Debouncing pattern for rapid user interactions"/>
      <codeRef path="src/pages/MagicCanvas.jsx" kind="function" symbol="handleCanvasChange" lines="246-274" reason="Element filtering pattern (exclude guide lines) for element tracking"/>
      <codeRef path="src/utils/logger.js" kind="class" symbol="Logger" lines="147-216" reason="Logging patterns for RowManager operation tracking"/>
      <codeRef path="src/utils/workspaceDB.js" kind="function" symbol="saveSessionState" lines="649-667" reason="Session persistence pattern for RowManager state"/>
      <codeRef path="src/utils/workspaceDB.js" kind="function" symbol="loadSessionState" lines="672-683" reason="Session restoration pattern for RowManager state"/>
      <codeRef path="src/utils/__tests__/guideLines.test.js" kind="test" symbol="describe" lines="45-96" reason="Test structure and mocking patterns for RowManager tests"/>
    </code>
    <dependencies>
      <dependency ecosystem="React" packages="react@^18.3.1, react-dom@^18.3.1" reason="Core React framework for component integration"/>
      <dependency ecosystem="Excalidraw" packages="@excalidraw/excalidraw@^0.18.0" reason="Canvas integration and element management"/>
      <dependency ecosystem="Testing" packages="vitest@^2.1.8, jsdom@^25.0.1" reason="Unit testing framework and DOM environment"/>
      <dependency ecosystem="Build" packages="vite@^6.0.7, @vitejs/plugin-react@^4.3.4" reason="Build system and module bundling"/>
      <dependency ecosystem="CAS" packages="katex@^0.16.11, algebrite@^1.4.0" reason="Mathematical expression parsing and validation"/>
      <dependency ecosystem="Storage" packages="No external dependencies - uses native IndexedDB API" reason="Client-side persistence following existing patterns"/>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="performance" description="O(1) lookup performance required for all row operations using Map-based storage"/>
    <constraint type="stability" description="Row IDs must be deterministic and stable across pan/zoom/reload operations"/>
    <constraint type="integration" description="Must integrate with existing Excalidraw canvas system and use updateScene() API"/>
    <constraint type="persistence" description="State must persist via IndexedDB using existing workspaceDB patterns"/>
    <constraint type="alignment" description="Row height must be 384px to align with OCR tile boundaries and guide lines"/>
    <constraint type="viewport" description="Must handle canvas bounds Y [-50000, +50000] and width 2000px"/>
    <constraint type="performance" description="Must handle 260+ rows efficiently while maintaining 60fps during pan/zoom"/>
    <constraint type="error-handling" description="Must follow existing error handling patterns from Texo utilities"/>
    <constraint type="documentation" description="Must use JSDoc documentation style consistent with existing codebase"/>
    <constraint type="testing" description="Must include comprehensive unit tests following existing test patterns"/>
  </constraints>
  <interfaces>
    <interface name="RowManager" kind="class" signature="class RowManager { constructor(rowHeight: number, startY: number); getRowForY(y: number): Row; assignElement(element: ExcalidrawElement): string; getRow(rowId: string): Row; updateRow(rowId: string, updates: Partial&lt;Row&gt;): void; getAllRows(): Row[]; getRowsInViewport(viewport: Viewport): Row[]; serialize(): object; deserialize(data: object): void; }" path="src/utils/rowManager.js"/>
    <interface name="Row" kind="interface" signature="interface Row { id: string; yStart: number; yEnd: number; elementIds: Set&lt;string&gt;; ocrStatus: 'pending' | 'processing' | 'completed' | 'error'; validationStatus: 'pending' | 'valid' | 'invalid' | 'error'; transcribedLatex: string | null; lastModified: number; tileHash: string | null; errorMessage: string | null; }" path="src/utils/rowManager.js"/>
    <interface name="Viewport" kind="interface" signature="interface Viewport { y: number; height: number; width?: number; x?: number; }" path="src/utils/rowManager.js"/>
    <interface name="ExcalidrawAPI" kind="api" signature="updateScene({ elements: ExcalidrawElement[] }): void; getSceneElements(): ExcalidrawElement[]; getAppState(): AppState;" path="src/pages/MagicCanvas.jsx"/>
    <interface name="Logger" kind="api" signature="debug(source: string, message: string, metadata?: object, tags?: string[]): void; info(source: string, message: string, metadata?: object, tags?: string[]): void; warn(source: string, message: string, metadata?: object, tags?: string[]): void; error(source: string, message: string, metadata?: object, tags?: string[]): void;" path="src/utils/logger.js"/>
  </interfaces>
  <tests>
    <standards>Use Vitest for unit tests with describe/it/expect pattern. Mock external dependencies (Excalidraw, IndexedDB) following existing test patterns. Test both positive and negative cases. Include performance tests for O(1) operations. Follow JSDoc documentation style. Use Map-based storage patterns consistent with existing Texo utilities. Implement error handling with try-catch blocks and proper logging.</standards>
    <locations>src/utils/__tests__/rowManager.test.js - Main test file for RowManager class. Follow existing pattern from guideLines.test.js. Use mocks for Excalidraw elements and IndexedDB operations.</locations>
    <ideas>
      <testIdea acId="1" description="Test RowManager instantiation with different rowHeight and startY configurations"/>
      <testIdea acId="2" description="Test getRowForY method with various Y coordinates including edge cases (negative, below startY, large values)"/>
      <testIdea acId="3" description="Test assignElement method with new elements, existing elements, and elements spanning multiple rows"/>
      <testIdea acId="4" description="Test row retrieval methods (getRow, getAllRows, getRowsInViewport) with valid and invalid row IDs"/>
      <testIdea acId="5" description="Test updateRow method with partial updates and invalid row IDs"/>
      <testIdea acId="6" description="Test row stability by verifying row IDs remain consistent across multiple getRowForY calls with same Y coordinate"/>
      <testIdea acId="7" description="Test serialize/deserialize methods for state persistence and restoration"/>
      <testIdea acId="8" description="Test performance with large numbers of rows (260+) to ensure O(1) operations"/>
      <testIdea acId="9" description="Test element reassignment when element moves from one row to another"/>
      <testIdea acId="10" description="Test edge cases: elements at exact row boundaries, very large/small Y coordinates"/>
    </ideas>
  </tests>
</story-context>