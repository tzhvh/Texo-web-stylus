<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>7</storyId>
    <title>Persist Row State and Canvas State Across Reloads</title>
    <status>drafted</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/1-7-persist-row-state-and-canvas-state-across-reloads.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>my canvas and row state to persist when I reload page</iWant>
    <soThat>I don't lose my work if I close browser tab</soThat>
    <tasks>- [ ] Task 1: Extend IndexedDB schema for Magic Canvas persistence (AC: 1, 2, 3, 4)
  - [ ] Subtask 1.1: Add magic-canvas-state store to workspaceDB.js
  - [ ] Subtask 1.2: Define schema versioning for future compatibility
  - [ ] Subtask 1.3: Implement saveMagicCanvasState() method
- [ ] Task 2: Implement auto-save with debouncing (AC: 1, 2, 3, 4)
  - [ ] Subtask 2.1: Hook into RowManager state changes
  - [ ] Subtask 2.2: Implement 2-second debounce timer
  - [ ] Subtask 2.3: Serialize Excalidraw scene and RowManager state
- [ ] Task 3: Implement state restoration on page load (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] Subtask 3.1: Load magic-canvas-state on component mount
  - [ ] Subtask 3.2: Deserialize and reconstruct RowManager
  - [ ] Subtask 3.3: Restore Excalidraw canvas with saved scene
  - [ ] Subtask 3.4: Handle corrupted/missing state gracefully
- [ ] Task 4: Add error handling and validation (AC: 8)
  - [ ] Subtask 4.1: Implement state corruption detection
  - [ ] Subtask 4.2: Add fallback to empty canvas on errors
  - [ ] Subtask 4.3: Log errors to existing diagnostic system
- [ ] Task 5: Performance optimization for large canvases (AC: 6)
  - [ ] Subtask 5.1: Benchmark restoration with 500+ elements
  - [ ] Subtask 5.2: Optimize serialization if needed
  - [ ] Subtask 5.3: Add loading indicator for slow restores</tasks>
  </story>

  <acceptanceCriteria>1. Given I have drawn content on Magic Canvas with rows in various states, When I reload page or close and reopen browser, Then canvas restores to my previous state
2. And all drawn strokes are restored in correct positions
3. And row assignments are restored (elements belong to same rows)
4. And row statuses are restored (OCR status, validation status, transcribed LaTeX)
5. And zoom level and pan position are restored
6. And restoration completes within 1 second for typical canvas (<500 elements)
7. And if no previous state exists, canvas loads empty with default view
8. And corrupted state is detected and handled gracefully (fallback to empty canvas, log error)</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/architecture.md" title="Magic Canvas - Decision Architecture" section="Pattern 3: State Synchronization (Canvas ↔ RowManager ↔ IndexedDB)" snippet="Unidirectional flow with debounced saves: Excalidraw (Visual State) → RowManager (Logical State) → IndexedDB (Persistence). RowManager serves as single truth source, preventing race conditions." />
      <doc path="docs/architecture.md" title="Magic Canvas - Decision Architecture" section="IndexedDB Schema" snippet="Store 1: magic-canvas-state (single record, key: 'current') with canvasState (ExcalidrawScene), rowManagerState (rowHeight, rows), timestamp, and version." />
      <doc path="docs/architecture.md" title="Magic Canvas - Decision Architecture" section="State Synchronization Rules" snippet="RowManager → IndexedDB (debounced): Triggered by any RowManager mutation, serialize state, save to magic-canvas-state store, timing: 2s after last change, async." />
      <doc path="docs/architecture.md" title="Magic Canvas - Decision Architecture" section="Crash Recovery" snippet="Auto-save every 2s → max 2s data loss on crash. Corrupted state detected on load → fallback to empty canvas, log error." />
      <doc path="docs/bmm-architecture.md" title="Texo-web-stylus Architecture" section="IndexedDB for Persistence" snippet="Database: texo-workspace-db (version 1) with 5 Object Stores including workspaces, cas-cache, session-state, diagnostic-logs, transformers-cache." />
      <doc path="docs/bmm-architecture.md" title="Texo-web-stylus Architecture" section="State Management Strategy" snippet="Three Layers: UI State (React useState/useContext), Persistent State (IndexedDB), Preferences (localStorage). IndexedDB for bulk data, localStorage for lightweight preferences." />
      <doc path="docs/sprint-artifacts/tech-spec-epic-1.md" title="Epic Technical Specification: Canvas Foundation & Row System" section="State Persistence Flow" snippet="Any row/canvas state change → trigger debounced save. After 2s of inactivity → serialize RowManager state and Excalidraw canvas. Save to IndexedDB store: magic-canvas-state with key 'current'." />
      <doc path="docs/sprint-artifacts/tech-spec-epic-1.md" title="Epic Technical Specification: Canvas Foundation & Row System" section="Canvas Initialization Flow" snippet="Component mounts → Initialize RowManager with default rowHeight (384px). Load persisted canvas state from IndexedDB (if exists). Deserialize canvas elements and row state. Initialize Excalidraw with loaded state." />
      <doc path="docs/epics.md" title="Texo-web-stylus - Epic Breakdown" section="Epic 5: Persistence & Workspace Integration" snippet="FR67: Auto-save row state to IndexedDB, FR68: Save vector strokes + transcribed LaTeX, FR69: Load canvas state on reload, FR74: Persist across browser sessions." />
    </docs>
    <code>
      <code path="src/utils/workspaceDB.js" kind="utility" symbol="saveSessionState/loadSessionState" lines="649-683" reason="Existing session state persistence functions that can be reused for Magic Canvas state storage" />
      <code path="src/utils/workspaceDB.js" kind="utility" symbol="IndexedDB schema" lines="16-22" reason="Current schema with 5 stores - need to add magic-canvas-state store for persistence" />
      <code path="src/utils/rowManager.js" kind="class" symbol="serialize/deserialize" lines="271-335" reason="RowManager already has serialization methods for persistence - use these for state saving" />
      <code path="src/hooks/useRowSystem.js" kind="hook" symbol="saveState/loadState" lines="139-238" reason="Hook already implements auto-save with debouncing and state loading - extend for Magic Canvas" />
      <code path="src/hooks/useRowSystem.js" kind="hook" symbol="scheduleAutoSave" lines="245-255" reason="Debounced auto-save implementation (2s default) - exactly what AC6 requires" />
      <code path="src/components/RowHeader.jsx" kind="component" symbol="status indicators" lines="32-96" reason="Visual feedback system for row states - will show persistence/restore status" />
    </code>
    <dependencies>
      <dependency ecosystem="IndexedDB" packages="workspaceDB.js (existing), session-state store (existing)" />
      <dependency ecosystem="React" packages="useState, useCallback, useRef, useEffect (existing patterns)" />
      <dependency ecosystem="Excalidraw" packages="@excalidraw/excalidraw (existing), getSceneElements, updateScene APIs" />
      <dependency ecosystem="Logging" packages="logger.js (existing) for error handling and diagnostics" />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Must extend existing IndexedDB schema without breaking current stores (workspaces, cas-cache, session-state, diagnostic-logs, transformers-cache)</constraint>
    <constraint>Must use existing workspaceDB.js patterns for consistency with other Texo features</constraint>
    <constraint>State restoration must complete within 1 second for typical canvases (<500 elements)</constraint>
    <constraint>Auto-save must be debounced (2 seconds) to avoid excessive IndexedDB writes</constraint>
    <constraint>Corrupted state detection required with fallback to empty canvas and error logging</constraint>
    <constraint>Must preserve Excalidraw scene state (elements, appState) and RowManager state (rows, element mappings)</constraint>
    <constraint>Schema versioning required for future compatibility (start with version 1)</constraint>
    <constraint>All errors must be logged through existing logger.js system</constraint>
    <constraint>No new dependencies allowed - must reuse existing Texo infrastructure</constraint>
  </constraints>
  <interfaces>
    <interface name="Magic Canvas State Persistence" kind="IndexedDB Store" signature="magic-canvas-state store with key: 'current'" path="src/utils/workspaceDB.js" />
    <interface name="RowManager Serialization" kind="Class Methods" signature="serialize(): SerializedState, deserialize(state): void" path="src/utils/rowManager.js" />
    <interface name="Excalidraw Scene Restoration" kind="API Methods" signature="updateScene(elements, appState), getSceneElements()" path="@excalidraw/excalidraw" />
    <interface name="Auto-save Debouncing" kind="Hook Configuration" signature="autoSaveMs=2000, scheduleAutoSave(), saveState(force)" path="src/hooks/useRowSystem.js" />
  </interfaces>
  <tests>
    <standards>Unit tests using Vitest with jsdom environment. Test RowManager serialization/deserialization with 500+ elements. Performance tests to verify <1s restoration time. Error handling tests for corrupted state. Integration tests for full save/load cycle. Manual browser tests for page reload scenarios.</standards>
    <locations>src/utils/__tests__/rowManager.test.js (extend existing), src/hooks/__tests__/useRowSystem.test.js (extend existing), src/utils/__tests__/workspaceDB.test.js (extend existing). Manual tests in browser for page reload behavior.</locations>
    <ideas>
      <test idea="AC1-4" ac="Full state restoration" description="Test with complex canvas: draw 100+ elements across multiple rows, set various OCR/validation states, reload page, verify all elements and row metadata restored correctly" />
      <test idea="AC5" ac="Zoom/pan restoration" description="Set zoom to 150% and pan to position, save state, reload page, verify zoom level and pan position restored exactly" />
      <test idea="AC6" ac="Performance test" description="Create canvas with 500 elements, time restoration process, verify completes within 1000ms target" />
      <test idea="AC7" ac="Empty canvas handling" description="Clear IndexedDB state, reload page, verify canvas loads empty with default view (no errors)" />
      <test idea="AC8" ac="Corrupted state handling" description="Manually corrupt saved state in IndexedDB, reload page, verify graceful fallback to empty canvas with error logged" />
      <test idea="Schema versioning" ac="Future compatibility" description="Test with version 1 state, then simulate version 2 schema changes, verify backward compatibility" />
      <test idea="Concurrent saves" ac="Race condition" description="Rapidly make changes during 2s debounce window, verify only final state saved, no data loss" />
    </ideas>
  </tests>
</story-context>