<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>2</storyId>
    <title>Integrate Excalidraw Canvas with Infinite Vertical Scroll</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-2-integrate-excalidraw-canvas-with-infinite-vertical-scroll.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>an infinite vertical canvas where I can draw freely</iWant>
    <soThat>I can write mathematical expressions without space constraints</soThat>
    <tasks>
- [ ] Task 1: Configure Excalidraw component with infinite canvas props (AC: #1, #5, #6)
  - [ ] Subtask 1.1: Import ExcalidrawAPI and install required Excalidraw packages
  - [ ] Subtask 1.2: Set up Excalidraw canvas with `viewModeEnabled={false}` to enable drawing
  - [ ] Subtask 1.3: Configure infinite canvas: set vertical scroll limits high (e.g., -50000 to +50000)
  - [ ] Subtask 1.4: Limit horizontal extent to ~2000px using appState initialization
  - [ ] Subtask 1.5: Test canvas extends vertically without horizontal space limits

- [ ] Task 2: Style canvas to fill viewport and match Texo design (AC: #1, #7)
  - [ ] Subtask 2.1: Container CSS: width 100%, height 100vh, flex layout
  - [ ] Subtask 2.2: Configure background color: white or light gray (`backgroundColor`)
  - [ ] Subtask 2.3: Hide/minimize Excalidraw toolbar (study SketchPage.jsx patterns)
  - [ ] Subtask 2.4: Verify canvas renders without visual artifacts

- [ ] Task 3: Enable pan and zoom interactions (AC: #2, #3, #4)
  - [ ] Subtask 3.1: Verify vertical pan works via mouse drag and touch drag
  - [ ] Subtask 3.2: Verify mouse wheel pan functionality
  - [ ] Subtask 3.3: Verify Ctrl+scroll zoom works (or pinch on touch devices)
  - [ ] Subtask 3.4: Test pan/zoom don't interfere with drawing strokes
  - [ ] Subtask 3.5: Verify zoom limits prevent infinite zoom in/out (reasonable bounds)

- [ ] Task 4: Enable drawing with stylus and mouse (AC: #2)
  - [ ] Subtask 4.1: Test pen/pencil tool works with mouse
  - [ ] Subtask 4.2: Test pen/pencil tool works with stylus input
  - [ ] Subtask 4.3: Verify strokes render smoothly without lag
  - [ ] Subtask 4.4: Test eraser functionality works
  - [ ] Subtask 4.5: Test element selection and manipulation work

- [ ] Task 5: Reference existing Texo patterns for consistency (AC: #1, #7, #8)
  - [ ] Subtask 5.1: Review SketchPage.jsx for Excalidraw integration patterns
  - [ ] Subtask 5.2: Follow existing theme/styling conventions from ComposePage.jsx
  - [ ] Subtask 5.3: Ensure component exports and integrates cleanly with App.jsx routing
  - [ ] Subtask 5.4: Document any deviations from existing patterns with rationale

- [ ] Task 6: Integration testing and edge cases
  - [ ] Subtask 6.1: Test canvas state on page load (verify it initializes correctly)
  - [ ] Subtask 6.2: Test rapid pan/zoom/draw sequences don't break canvas
  - [ ] Subtask 6.3: Test on mobile device (touch pan, pinch zoom)
  - [ ] Subtask 6.4: Test browser resize (canvas should reflow to new viewport)
  - [ ] Subtask 6.5: Verify no console warnings or errors during typical use
    </tasks>
  </story>

  <acceptanceCriteria>
| # | Acceptance Criterion |
|---|---|
| 1 | **Given** I am on the Magic Canvas page **When** the page loads **Then** I see an Excalidraw canvas that fills the viewport |
| 2 | **And** I can draw strokes with mouse or stylus |
| 3 | **And** I can pan vertically by dragging with touch or mouse wheel |
| 4 | **And** I can zoom in/out using pinch gestures or Ctrl+scroll |
| 5 | **And** the canvas extends infinitely in the vertical direction |
| 6 | **And** horizontal extent is limited to reasonable width (e.g., 2000px) |
| 7 | **And** canvas background is white or light gray |
| 8 | **And** Excalidraw toolbar is minimal or hidden by default |
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Canvas & Drawing Capabilities (FR1-FR10), Web Application Specific Requirements</section>
        <snippet>Canvas displays horizontal ruled lines as visual guides for row boundaries. Users can pan vertically through canvas with touch/mouse, zoom in/out using pinch or Ctrl+scroll, and draw with stylus or mouse. Canvas state (zoom level, pan position) persists across page reloads.</snippet>
      </artifact>
      <artifact>
        <path>docs/architecture.md</path>
        <title>Magic Canvas - Decision Architecture</title>
        <section>Epic 1: Canvas Foundation & Row System, Project Structure</section>
        <snippet>MagicCanvas.jsx embeds Excalidraw, hosts row lines overlay. Uses existing @excalidraw/excalidraw v0.x package. Configure viewModeEnabled={false} to enable drawing. Study src/pages/SketchPage.jsx for Excalidraw integration patterns. Canvas state managed via React hooks.</snippet>
      </artifact>
      <artifact>
        <path>docs/epics.md</path>
        <title>Epic Breakdown - Magic Canvas Feature</title>
        <section>Story 1.2: Integrate Excalidraw Canvas with Infinite Vertical Scroll</section>
        <snippet>Create src/pages/MagicCanvas.jsx main component. Update src/App.jsx to add route. Add navigation link in app header/menu. Use React.lazy() for code splitting. Follow existing Texo page structure patterns (SketchPage.jsx, ComposePage.jsx). Canvas state will be managed via React hooks (detailed in later stories).</snippet>
      </artifact>
      <artifact>
        <path>CLAUDE.md</path>
        <title>AI Development Guide - Texo-web-stylus</title>
        <section>Project Overview, Development Commands, Architecture, Excalidraw Stroke Extraction</section>
        <snippet>SketchPage uses Excalidraw's canvas to capture stylus input. App extracts freedraw stroke elements, converts to bitmap (384x384), sends to OCR worker, returns LaTeX. Bounding box: Fixed 384x384 box at coordinates (50, 50) guides cropping. This story extends existing patterns.</snippet>
      </artifact>
    </docs>

    <code>
      <artifact>
        <path>src/pages/SketchPage.jsx</path>
        <kind>component</kind>
        <symbol>SketchPage</symbol>
        <lines>Full file</lines>
        <reason>Reference implementation for Excalidraw integration. Study UIOptions, canvas configuration, OnChange callback patterns. Shows existing Texo patterns for Excalidraw usage.</reason>
      </artifact>
      <artifact>
        <path>src/pages/ComposePage.jsx</path>
        <kind>component</kind>
        <symbol>ComposePage</symbol>
        <lines>Full file</lines>
        <reason>Styling and layout patterns to follow. Demonstrates full-viewport component structure, Tailwind CSS classes, integration with existing Texo features.</reason>
      </artifact>
      <artifact>
        <path>src/App.jsx</path>
        <kind>component</kind>
        <symbol>App</symbol>
        <lines>Route definitions section</lines>
        <reason>Understand routing structure. Story 1.1 already added /magic-canvas route. This story modifies MagicCanvas.jsx component implementation, App.jsx unchanged unless route needs adjustment.</reason>
      </artifact>
      <artifact>
        <path>src/pages/MagicCanvas.jsx</path>
        <kind>component</kind>
        <symbol>MagicCanvas</symbol>
        <lines>Entire file (new implementation)</lines>
        <reason>Main component for this story. Created in Story 1.1 as stub. This story implements Excalidraw canvas with infinite vertical scroll, pan/zoom, drawing, styling.</reason>
      </artifact>
    </code>

    <dependencies>
      <npm>
        <name>@excalidraw/excalidraw</name>
        <version>Latest in package.json (v0.x)</version>
        <reason>Core Excalidraw component for drawing canvas. Already in project dependencies.</reason>
      </npm>
      <npm>
        <name>react</name>
        <version>v18.x (existing)</version>
        <reason>Component framework. Already in project.</reason>
      </npm>
      <npm>
        <name>tailwindcss</name>
        <version>v3.x (existing)</version>
        <reason>Styling for canvas container (h-screen w-full, background colors, layout).</reason>
      </npm>
      <npm>
        <name>@excalidraw/excalidraw types</name>
        <version>Latest (existing)</version>
        <reason>TypeScript types for Excalidraw API (ExcalidrawAPI, ExcalidrawElement, AppState).</reason>
      </npm>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
      <category>Architecture</category>
      <rule>Must use existing Excalidraw integration patterns from SketchPage.jsx. Do not introduce new dependencies or diverge from established patterns.</rule>
      <reason>Consistency with existing Texo codebase, reduce maintenance burden.</reason>
    </constraint>
    <constraint>
      <category>Performance</category>
      <rule>Canvas must maintain 60fps during pan/zoom/draw operations. No jank or frame drops.</rule>
      <reason>Critical for user experience and flow state preservation (PRD requirement).</reason>
    </constraint>
    <constraint>
      <category>UI/UX</category>
      <rule>Canvas background must be white or light gray (#f5f5f5 recommended). Excalidraw toolbar should be hidden or minimal.</rule>
      <reason>Follow Texo design language, create minimal UI chrome consistent with focus-enabling design philosophy.</reason>
    </constraint>
    <constraint>
      <category>Compatibility</category>
      <rule>Must support drawing with both mouse and stylus input on desktop and mobile.</rule>
      <reason>Primary target is tablet devices with stylus (iPad Pro, Surface Pro, Galaxy Tab).</reason>
    </constraint>
    <constraint>
      <category>Integration</category>
      <rule>Canvas state must be accessible via ExcalidrawAPI for later stories (row manager, OCR pipeline, validation).</rule>
      <reason>Story 1.4-1.8 depend on element access for row assignment and state management.</reason>
    </constraint>
    <constraint>
      <category>Testing</category>
      <rule>Must test on actual tablet/stylus device, not just desktop mouse. Pan/zoom must feel natural.</rule>
      <reason>Core product requirement: stylus drawing is primary interaction mode.</reason>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>ExcalidrawAPI</name>
      <kind>React Component API</kind>
      <signature>const [excalidrawAPI, setExcalidrawAPI] = useState(null); &lt;Excalidraw onChange={handleChange} onPointerUpdate={...} ref={excalidrawRef} /&gt;</signature>
      <path>src/pages/SketchPage.jsx (reference)</path>
      <notes>ExcalidrawAPI provides methods: updateScene(), getSceneElements(), scrollToContent(). Store API reference in component state for later access by row manager (Story 1.4-1.5).</notes>
    </interface>
    <interface>
      <name>Excalidraw onChange Event</name>
      <kind>Event handler</kind>
      <signature>onChange: (elements, appState, files) =&gt; void</signature>
      <path>@excalidraw/excalidraw component</path>
      <notes>Fired on every canvas change (draw, pan, zoom, delete). Later stories (1.5, 1.8) hook into this to detect row assignment changes.</notes>
    </interface>
    <interface>
      <name>ExcalidrawElement</name>
      <kind>Data structure</kind>
      <signature>{ id, type, x, y, width, height, ... } (freedraw, rectangle, text, etc.)</signature>
      <path>@excalidraw/excalidraw types</path>
      <notes>Each element has position (x, y) used for row assignment in Story 1.5. Type filtering needed to identify drawable elements.</notes>
    </interface>
    <interface>
      <name>AppState Configuration</name>
      <kind>Excalidraw configuration object</kind>
      <signature>{ viewBackgroundColor, isBindingEnabled, gridMode, ...}</signature>
      <path>@excalidraw/excalidraw docs</path>
      <notes>Configure canvas behavior: background color, grid, binding, scroll limits. Study Excalidraw docs for infinite canvas configuration parameters.</notes>
    </interface>
  </interfaces>

  <tests>
    <standards>
Manual browser testing required for UI interactions (stylus/mouse drawing, pan/zoom). No automated unit tests for Excalidraw integration (component testing is difficult in Vitest). Focus on integration testing: load page, draw strokes, verify canvas state, test pan/zoom, test on actual tablet device with stylus. Regression tests ensure no breaking changes to existing SketchPage or App routing.
    </standards>
    <locations>
Manual testing checklist (document in story completion notes):
- Magic Canvas page loads without errors
- Excalidraw canvas visible and responsive
- Drawing with mouse works smoothly (stroke appears immediately)
- Drawing with stylus works on tablet
- Pan vertical (drag middle mouse/touch) scrolls canvas
- Zoom (pinch on touch, Ctrl+scroll on desktop) changes scale
- Canvas extends infinitely in vertical direction (scroll beyond initial bounds)
- Horizontal extent limited (~2000px)
- Background is light gray or white
- Toolbar is hidden/minimal
- No console warnings or errors
- Browser resize doesn't break canvas
    </locations>
    <ideas>
**AC #1 (Canvas fills viewport):** Test: Page load → verify canvas.height === window.innerHeight, canvas.width === window.innerWidth

**AC #2 (Draw with mouse/stylus):** Test: Draw strokes with mouse → verify elements appear in scene. Test on tablet with stylus → verify strokes render smoothly, no lag.

**AC #3 (Vertical pan):** Test: Middle-mouse drag upward → canvas pans down (content moves up). Touch drag upward → same. Mouse wheel scroll → pans smoothly.

**AC #4 (Zoom):** Test: Ctrl+scroll → zoom in/out. Pinch on touchscreen → zoom. Verify zoom limits prevent extreme zoom.

**AC #5 (Infinite vertical):** Test: Draw at canvas top → scroll up past boundary → confirm canvas extends higher. Repeat at bottom → extends lower. No hard limits (except reasonable -50000 to +50000).

**AC #6 (Limited horizontal):** Test: Draw wide → confirm max width ~2000px. Can't scroll beyond horizontal bounds.

**AC #7 (Light background):** Test: Canvas background color is #f5f5f5 (light gray) or white. Not darker.

**AC #8 (Minimal toolbar):** Test: Toolbar hidden or very minimal. Main focus is canvas, not UI chrome.

**Edge cases:**
- Rapid pan/zoom/draw (should not freeze or drop strokes)
- Mobile device: touch gestures, stylus, screen rotation
- Very long drawing session (memory not exhausted)
- Undo/redo functionality works
    </ideas>
  </tests>
</story-context>
