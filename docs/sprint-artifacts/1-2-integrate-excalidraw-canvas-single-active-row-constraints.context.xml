<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>2</storyId>
    <title>integrate-excalidraw-canvas-single-active-row-constraints</title>
    <status>drafted</status>
    <generatedAt>2025-11-22</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/home/mser/Documents/cla/w/Texo-web-stylus/docs/sprint-artifacts/1-2-integrate-excalidraw-canvas-single-active-row-constraints.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>an infinite vertical canvas where I can draw freely within the active row only</iWant>
    <soThat>I can write mathematical expressions without space constraints while maintaining clear row boundaries</soThat>
    <tasks>Task 1: Set up Excalidraw canvas integration (AC: 1, 7, 8)
  - Subtask 1.1: Import and configure @excalidraw/excalidraw in MagicCanvas.jsx
  - Subtask 1.2: Configure canvas to fill viewport with appropriate dimensions
  - Subtask 1.3: Set canvas background to white/light gray
  - Subtask 1.4: Minimize or hide Excalidraw toolbar by default
  - Subtask 1.5: Study existing SketchPage.jsx patterns for integration reference

Task 2: Implement row-based drawing constraints (AC: 2, 9)
  - Subtask 2.1: Create row boundary detection logic (Y-coordinate filtering)
  - Subtask 2.2: Implement onChange handler to filter strokes by active row bounds
  - Subtask 2.3: Prevent or constrain strokes outside active row Y: rowStart to rowEnd
  - Subtask 2.4: Test constraint enforcement with various drawing scenarios

Task 3: Enable zoom and viewport controls (AC: 3, 6)
  - Subtask 3.1: Configure zoom in/out with pinch gestures for touch devices
  - Subtask 3.2: Configure zoom in/out with Ctrl+scroll for desktop
  - Subtask 3.3: Ensure row width limited to viewport (no horizontal scroll)
  - Subtask 3.4: Test zoom behavior maintains row constraints

Task 4: Implement multi-row display system (AC: 5, 10)
  - Subtask 4.1: Render multiple rows vertically on canvas
  - Subtask 4.2: Ensure only one row is active at a time (single-active-row model)
  - Subtask 4.3: Display horizontal ruled lines at row boundaries (Y: rowStart and rowEnd)
  - Subtask 4.4: Make row boundaries visually clear and distinct

Task 5: Add row switching capabilities (AC: 4)
  - Subtask 5.1: Implement swipe gesture detection for vertical row switching
  - Subtask 5.2: Implement arrow key handling (Up/Down) for row switching
  - Subtask 5.3: Update active row highlighting when switching
  - Subtask 5.4: Maintain drawing constraints when switching between rows

Task 6: Performance optimization and testing (AC: 1-10)
  - Subtask 6.1: Optimize for 60fps during drawing operations
  - Subtask 6.2: Test with various input methods (mouse, stylus, touch)
  - Subtask 6.3: Verify no memory leaks during extended drawing sessions
  - Subtask 6.4: Test edge cases (rapid drawing, boundary conditions)</tasks>
  </story>

  <acceptanceCriteria>1. Given I am on the Magic Canvas page with row 3 active, When the page loads, Then I see an Excalidraw canvas that fills the viewport

2. And I can draw strokes with mouse or stylus only within row 3 bounds (Y: rowStart to rowEnd)

3. And I can zoom in/out using pinch gestures or Ctrl+scroll (zoom only, no vertical pan)

4. And I can switch between rows using swipe gestures (up/down) or arrow keys

5. And the canvas displays multiple rows vertically, with one row active at a time

6. And each row is limited to width of viewport (no horizontal scroll needed)

7. And canvas background is white or light gray

8. And Excalidraw toolbar is minimal or hidden by default

9. And attempts to draw outside active row bounds are prevented or constrained to active row bounds

10. And row boundaries are visually clear (horizontal ruled lines at Y: rowStart and rowEnd)</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/PRD.md" title="Product Requirements Document" section="Canvas & Drawing Capabilities" snippet="Magic Canvas transforms Texo-web-stylus into a mindful mathematical note-taking tool where users write naturally with a stylus and receive instant, silent validation feedback. Each handwritten equation is transcribed via intelligent OCR tiling and validated against the previous line using existing CAS, with colored ✓/✗ symbols appearing directly on the canvas." />
      <doc path="docs/PRD.md" title="Product Requirements Document" section="Row System Capabilities" snippet="Only the active row is editable; all other rows are read-only. Each row has a stable unique ID that persists across pan/zoom/reload. System maintains row metadata including Y-position, active status, OCR status, validation status, and transcribed LaTeX." />
      <doc path="docs/architecture.md" title="Decision Architecture" section="Epic 1: Canvas Foundation & Row System" snippet="RowManager class (active row selector + activation timeline tracker). Row height: 384px (matches OCR tile height). Active row: Only one row editable at a time, rest are read-only overlays. Row switching: Gestures (swipe) or keyboard (arrow keys) change active row." />
      <doc path="docs/architecture.md" title="Decision Architecture" section="RowManager Internal State" snippet="Row interface includes id, yStart, yEnd, isActive, ocrStatus, validationStatus, transcribedLatex, activatedAt, errorMessage. Only one row can be active at a time (enforced by setActiveRow)." />
      <doc path="docs/epic_1_complete_breakdown.md" title="Epic 1 Complete Breakdown" section="Story 1.2" snippet="Use @excalidraw/excalidraw package (already in dependencies). Configure Excalidraw with viewModeEnabled={false} (allow drawing), infinite canvas configuration, hide unnecessary UI chrome. Implement drawing constraints in onChange handler (filter strokes by Y-coordinate bounds)." />
    </docs>
    <code>
      <artifact path="src/pages/MagicCanvas.jsx" kind="component" symbol="MagicCanvasComponent" lines="22-27" reason="Excalidraw canvas configuration with infinite canvas, background color, and UI options for minimal toolbar">
        <snippet>const CANVAS_CONFIG = {
  MIN_Y: -50000,
  MAX_Y: 50000,
  MAX_WIDTH: 2000,
  BACKGROUND_COLOR: "#f5f5f5", // Light gray per design
};</snippet>
      </artifact>
      <artifact path="src/pages/MagicCanvas.jsx" kind="component" symbol="createGuideLine" lines="30-50" reason="Creates horizontal ruled lines for row guidance with correct styling and locked property">
        <snippet>const createGuideLine = (y, id) => {
  const guideLine = convertToExcalidrawElements([
    {
      type: "line",
      x: 0,
      y: y,
      width: CANVAS_CONFIG.MAX_WIDTH,
      height: 0,
      strokeColor: "#d3d3d3", // Light gray per Story 1.3, Task 2.1
      backgroundColor: "transparent",
      strokeWidth: 1, // 1px stroke per Story 1.3, Task 2.2
      strokeStyle: "solid",
      roughness: 0,
      opacity: 30, // Subtle opacity for non-interference per Story 1.3, Task 2.1
      locked: true, // Prevent user interaction per Story 1.3, Task 2.3
      isDeleted: false,
      id: id || `guide-${y}`,
    },
  ]);
  return guideLine[0];
};</snippet>
      </artifact>
      <artifact path="src/pages/MagicCanvas.jsx" kind="component" symbol="generateViewportGuideLines" lines="64-79" reason="Viewport-culled guide line generation for performance optimization">
        <snippet>const generateViewportGuideLines = (
  viewportY,
  viewportHeight,
  spacing = 384,
  buffer = 2000,
) => {
  const startY = Math.floor((viewportY - buffer) / spacing) * spacing;
  const endY =
    Math.ceil((viewportY + viewportHeight + buffer) / spacing) * spacing;

  const guideLines = [];
  for (let y = startY; y <= endY; y += spacing) {
    guideLines.push(createGuideLine(y));
  }
  return guideLines;
};</snippet>
      </artifact>
      <artifact path="src/pages/SketchPage.jsx" kind="component" symbol="Excalidraw" lines="403-425" reason="Reference implementation for Excalidraw integration with UI options and canvas configuration">
        <snippet>&lt;Excalidraw
  excalidrawAPI={(api) => setExcalidrawAPI(api)}
  initialData={{
    appState: {
      viewBackgroundColor: "#ffffff",
      currentItemStrokeColor: "#000000",
      currentItemBackgroundColor: "transparent",
      currentItemFillStyle: "solid",
      currentItemStrokeWidth: 2,
      currentItemRoughness: 0,
      currentItemOpacity: 100,
    },
    elements: [boundingBoxRef.current],
    scrollToContent: false,
  }}
  UIOptions={{
    canvasActions: {
      loadScene: false,
      export: false,
      saveAsImage: false,
    },
  }}
/&gt;</snippet>
      </artifact>
      <artifact path="src/hooks/useRowSystem.js" kind="hook" symbol="useRowSystem" lines="47-54" reason="React hook for synchronizing Excalidraw canvas with RowManager for element-to-row assignments">
        <snippet>export default function useRowSystem({ 
  excalidrawAPI, 
  rowManager, 
  debounceMs = 50, 
  debugMode = false,
  workspaceId = 'default',
  autoSaveMs = 2000
}) {</snippet>
      </artifact>
      <artifact path="src/utils/rowManager.js" kind="class" symbol="RowManager" lines="53-68" reason="Core class for managing row state with single-active-row model and element assignments">
        <snippet>constructor({ rowHeight = 384, startY = 0 } = {}) {
    this.rowHeight = rowHeight;
    this.startY = startY;
    
    // Map<string, Row> - All rows by ID for O(1) lookup
    this.rows = new Map();
    
    // Map<string, string> - Element ID to row ID mapping for O(1) element lookup
    this.elementToRow = new Map();
    
    Logger.debug('RowManager', 'Initialized', {
      rowHeight,
      startY,
      timestamp: Date.now()
    });
  }</snippet>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="React">
        <package name="@excalidraw/excalidraw" version="^0.18.0" usage="Canvas drawing engine with infinite canvas support and UI customization" />
        <package name="react" version="^18.3.1" usage="React framework for component lifecycle and state management" />
        <package name="react-helmet-async" version="^2.0.5" usage="Page metadata management for SEO and page titles" />
      </ecosystem>
      <ecosystem name="CAS & OCR">
        <package name="@huggingface/transformers" version="^3.2.3" usage="FormulaNet OCR model for handwriting transcription (future integration)" />
        <package name="katex" version="^0.16.11" usage="LaTeX rendering and parsing for mathematical expressions" />
        <package name="algebrite" version="^1.4.0" usage="Computer algebra system for mathematical validation (future integration)" />
      </ecosystem>
      <ecosystem name="Development">
        <package name="vitest" version="^2.1.8" usage="Testing framework for unit tests and component testing" />
        <package name="vite" version="^6.0.7" usage="Build tool and development server with hot reload" />
        <package name="tailwindcss" version="^3.4.17" usage="CSS framework for styling and responsive design" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint name="Single-Active-Row Model" description="Only one row can be editable at a time. All other rows must be read-only with visual dimming. Enforced by RowManager.setActiveRow() method." />
    <constraint name="Row Height: 384px" description="Fixed row height of 384px to match OCR tile dimensions. Configurable in future stories but fixed for MVP." />
    <constraint name="Viewport Width Limitation" description="Canvas width limited to viewport (no horizontal scroll). MAX_WIDTH: 2000px in CANVAS_CONFIG." />
    <constraint name="Drawing Constraints" description="Strokes only allowed within active row Y-bounds. Implement via onChange handler filtering before element creation." />
    <constraint name="Performance Target: 60fps" description="All canvas operations (drawing, zooming, guide line rendering) must maintain 60fps (16ms frame budget)." />
    <constraint name="Excalidraw Integration Pattern" description="Follow existing SketchPage.jsx patterns for Excalidraw API usage, UI options, and error handling." />
    <constraint name="No New Dependencies" description="Use existing @excalidraw/excalidraw package. No additional npm packages required for this story." />
  </constraints>
  <interfaces>
    <interface name="Excalidraw API" kind="component-api" signature="excalidrawAPI={setExcalidrawAPI}" path="src/pages/MagicCanvas.jsx" description="Provides access to canvas methods like getSceneElements(), updateScene(), getAppState()">
      <method name="getSceneElements" signature="(): Array&lt;ExcalidrawElement&gt;" description="Returns all elements currently in the scene" />
      <method name="updateScene" signature="(scene: {elements?, appState?}): void" description="Updates the canvas with new elements and/or app state" />
      <method name="getAppState" signature="(): ExcalidrawAppState" description="Returns current application state (zoom, scroll, etc.)" />
      <method name="onChange" signature="(elements: Array, appState: Object, files: Array): void" description="Callback fired when canvas changes" />
    </interface>
    <interface name="RowManager" kind="class-api" signature="new RowManager({rowHeight, startY})" path="src/utils/rowManager.js" description="Manages row state and element-to-row assignments with O(1) lookup performance">
      <method name="assignElement" signature="(element: ExcalidrawElement): string" description="Assigns element to row based on Y-coordinate, returns rowId" />
      <method name="setActiveRow" signature="(rowId: string): void" description="Sets active row (not implemented in this story but available)" />
      <method name="getActiveRow" signature="(): Row | null" description="Returns currently active row object" />
      <method name="getRowForY" signature="(y: number): Row | null" description="Gets row containing given Y-coordinate" />
    </interface>
    <interface name="useRowSystem Hook" kind="react-hook" signature="useRowSystem({excalidrawAPI, rowManager, options})" path="src/hooks/useRowSystem.js" description="React hook for canvas-row synchronization with debounced processing">
      <method name="handleCanvasChange" signature="(elements, appState, files): void" description="Debounced handler for Excalidraw onChange events" />
      <method name="getElementRow" signature="(elementId: string): string | null" description="Returns row ID for given element ID" />
      <method name="saveState" signature="(): Promise&lt;void&gt;" description="Manually saves current state to IndexedDB" />
      <method name="loadState" signature="(): Promise&lt;boolean&gt;" description="Loads state from IndexedDB, returns success flag" />
    </interface>
  </interfaces>
  <tests>
    <standards>Manual browser testing required for drawing constraints and row switching. Verify 60fps performance during drawing operations. Test with various input methods (mouse, stylus, touch). Ensure existing Texo pages remain functional (brownfield requirement). Test edge cases: drawing at row boundaries, rapid switching, zoom behavior.</standards>
    <locations>Manual browser testing for UI interactions. Unit tests in src/utils/__tests__/ for RowManager and utility functions. Integration tests for canvas-row synchronization.</locations>
    <ideas>
      <test ac="1" idea="Test canvas fills viewport on page load with white/light gray background">Verify Excalidraw renders with correct dimensions and background color from CANVAS_CONFIG.BACKGROUND_COLOR.</test>
      <test ac="2" idea="Test drawing constraints within active row bounds">Draw strokes in active row, attempt to draw outside active row - verify strokes are constrained or prevented.</test>
      <test ac="3" idea="Test zoom in/out with pinch gestures and Ctrl+scroll">Test touch pinch gestures on mobile/tablet, test Ctrl+scroll on desktop. Verify zoom-only behavior (no vertical pan).</test>
      <test ac="4" idea="Test row switching via swipe gestures and arrow keys">Test swipe up/down gestures, test Up/Down arrow keys. Verify active row changes and viewport scrolls to center.</test>
      <test ac="5" idea="Test multi-row display with single active row">Verify multiple rows visible with horizontal ruled lines, only one row highlighted as active.</test>
      <test ac="6" idea="Test viewport width limitation">Resize browser window, verify no horizontal scroll appears, canvas content fits within viewport.</test>
      <test ac="7" idea="Test canvas background color">Verify canvas background is white or light gray as specified in CANVAS_CONFIG.</test>
      <test ac="8" idea="Test minimal/hidden Excalidraw toolbar">Verify UIOptions configuration hides unnecessary toolbar elements while keeping drawing functionality.</test>
      <test ac="9" idea="Test drawing constraint enforcement">Attempt various drawing scenarios outside active row - verify proper constraint enforcement.</test>
      <test ac="10" idea="Test row boundary visibility">Verify horizontal ruled lines are clear and positioned at correct Y coordinates (rowStart and rowEnd).</test>
    </ideas>
  </tests>
</story-context>